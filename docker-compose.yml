version: '3.9'

services:
  bdr-postgresql:
    image: bitnami/postgresql:17
    container_name: bdr_postgres
    environment:
      POSTGRESQL_USERNAME: bdr
      POSTGRESQL_PASSWORD: bdr
      POSTGRESQL_DATABASE: bdr
    ports:
      - "5432:5432"
    volumes:
      - ./schema_sql/:/docker-entrypoint-initdb.d/
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "bdr"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - garage-network

    reverse_proxy:
      image: traefik:v2.10
      container_name: reverse_proxy
      command:
        - "--providers.docker=true"
        - "--providers.docker.exposedbydefault=false"
        - "--entrypoints.http.address=:80"
        - "--entrypoints.https.address=:443"
        - "--api.insecure=true"
        - "--certificatesresolvers.default.acme.tlschallenge=true" # For automatic HTTPS
      ports:
        - "80:80"   # HTTP traffic
        - "443:443" # HTTPS traffic
        - "8081:8080" # Traefik Dashboard
      volumes:
        - "/var/run/docker.sock:/var/run/docker.sock:ro"
        - "./certificates:/etc/traefik/certificates" # Mount certificates folder
      networks:
        - garage-network

      # Labels for Static and API Services to enable HTTPS
      static-server:
        build:
          context: ./path_to_static_server
        expose:
          - "80"
        labels:
          - "traefik.enable=true"
          - "traefik.http.routers.static.rule=Host(`localhost`)"
          - "traefik.http.services.static.loadbalancer.server.port=80"
          - "traefik.http.routers.static.entrypoints=https"
          - "traefik.http.routers.static.tls=true" # Enable TLS for Static Service

      dynamic-api:
        build:
          context: ./path_to_dynamic_api
        expose:
          - "8080"
        labels:
          - "traefik.enable=true"
          - "traefik.http.routers.api.rule=PathPrefix(`/api`)"
          - "traefik.http.services.api.loadbalancer.server.port=8080"
          - "traefik.http.routers.api.entrypoints=https"
          - "traefik.http.routers.api.tls=true" # Enable TLS for Dynamic API Service
        networks:
          - garage-network

    portainer:
      image: portainer/portainer-ce:latest
      container_name: portainer
      ports:
        - "9000:9000"  # Web UI port
      volumes:
        - "/var/run/docker.sock:/var/run/docker.sock"  # Allow access to Docker API
        - "portainer_data:/data"  # Store Portainer data persistently
      networks:
        - garage-network

volumes:
  postgres_data:
    driver: local

networks:
  garage-network:
    driver: bridge
